<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时资产仪表盘 - 多币种同步转换</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --primary: #6366f1;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --highlight: #f8fafc;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .dashboard {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .header {
            padding: 24px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 1.25rem; margin: 0; font-weight: 800; color: var(--primary); }
        .sync-status { font-size: 0.75rem; color: var(--text-muted); }

        .currency-list { padding: 8px 0; }

        .currency-row {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }
        .currency-row:last-child { border-bottom: none; }
        .currency-row:focus-within { background: var(--highlight); }

        .info { display: flex; align-items: center; flex: 1; }
        .icon { 
            width: 36px; height: 36px; 
            border-radius: 50%; 
            background: #f1f5f9; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-right: 12px;
            color: var(--text-muted);
        }

        .name-meta { display: flex; flex-direction: column; }
        .code { font-weight: 700; font-size: 1rem; }
        .full-name { font-size: 0.75rem; color: var(--text-muted); }

        .input-wrapper { flex: 1.5; display: flex; justify-content: flex-end; }
        .currency-input {
            width: 100%;
            max-width: 200px;
            border: 2px solid transparent;
            background: #f8fafc;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: right;
            color: var(--text-main);
            outline: none;
            transition: all 0.2s ease;
        }
        .currency-input:focus {
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .asset-tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
        }
        .tag-fiat { background: #dcfce7; color: #166534; }
        .tag-crypto { background: #fef9c3; color: #854d0e; }
        .tag-metal { background: #fee2e2; color: #991b1b; }

        @media (max-width: 480px) {
            .currency-row { padding: 12px 16px; }
            .currency-input { max-width: 140px; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="header">
        <div>
            <h1>多币种实时换算</h1>
            <div class="sync-status" id="status">正在同步全球汇率...</div>
        </div>
        <i class="fa-solid fa-arrows-rotate" id="refresh-icon" style="color: var(--primary); cursor: pointer;"></i>
    </div>

    <div class="currency-list" id="list-container"></div>
</div>

<script>
// 资产定义
const ASSETS = [
    { code: 'CNY', name: '人民币', type: 'fiat', icon: 'fa-yen-sign' },
    { code: 'USD', name: '美元', type: 'fiat', icon: 'fa-dollar-sign' },
    { code: 'EUR', name: '欧元', type: 'fiat', icon: 'fa-euro-sign' },
    { code: 'HKD', name: '港币', type: 'fiat', icon: 'fa-h' },
    { code: 'BTC', name: '比特币', type: 'crypto', icon: 'fa-brands fa-bitcoin' },
    { code: 'ETH', name: '以太坊', type: 'crypto', icon: 'fa-brands fa-ethereum' },
    { code: 'XAU', name: '现货黄金 (盎司)', type: 'metal', icon: 'fa-coins' },
    { code: 'XAG', name: '现货白银 (盎司)', type: 'metal', icon: 'fa-gem' }
];

let rates = {}; // 存储由 Worker 返回的 1 USD = N 资产单位
const listContainer = document.getElementById('list-container');
const statusText = document.getElementById('status');

// 1. 初始化界面
function initDashboard() {
    ASSETS.forEach(asset => {
        const row = document.createElement('div');
        row.className = 'currency-row';
        row.innerHTML = `
            <div class="info">
                <div class="icon"><i class="fa-solid ${asset.icon}"></i></div>
                <div class="name-meta">
                    <div style="display:flex; align-items:center">
                        <span class="code">${asset.code}</span>
                        <span class="asset-tag tag-${asset.type}">${asset.type === 'fiat' ? '法币' : asset.type === 'crypto' ? '加密' : '贵金属'}</span>
                    </div>
                    <span class="full-name">${asset.name}</span>
                </div>
            </div>
            <div class="input-wrapper">
                <input type="number" 
                       class="currency-input" 
                       id="input-${asset.code}" 
                       data-code="${asset.code}"
                       placeholder="0.00"
                       step="any">
            </div>
        `;
        listContainer.appendChild(row);

        const inputEl = row.querySelector('input');
        
        // 监听输入事件
        inputEl.addEventListener('input', (e) => {
            handleInputChange(e.target.dataset.code, e.target.value);
        });

        // 需求完善：激活输入框时，自动设置为1并全选
        inputEl.addEventListener('focus', (e) => {
            const val = 1;
            e.target.value = val;
            handleInputChange(e.target.dataset.code, val);
            
            // 使用 setTimeout 确保在浏览器完成点击定位后执行全选
            setTimeout(() => {
                e.target.select();
            }, 50);
        });
    });
}

// 2. 从 Cloudflare Worker 获取聚合数据
async function fetchRates() {
    try {
        statusText.innerText = "同步中...";
        
        // 使用你部署的 Worker 地址
        const response = await fetch('https://currency-rate.chengshen.me');
        if (!response.ok) throw new Error('网络响应不正常');
        
        const data = await response.json();
        
        if (data.rates) {
            rates = data.rates;
            statusText.innerText = `最后更新: ${new Date().toLocaleTimeString()}`;
            
            // 首次加载或未在输入时，默认显示 100 人民币的换算结果
            const activeInput = document.activeElement;
            if (!activeInput || !activeInput.classList.contains('currency-input')) {
                const cnyInput = document.getElementById('input-CNY');
                cnyInput.value = 100;
                handleInputChange('CNY', 100);
            }
        }
    } catch (error) {
        statusText.innerText = "数据同步失败，请检查网络";
        console.error("Fetch Error:", error);
    }
}

// 3. 联动换算逻辑
function handleInputChange(sourceCode, value) {
    if (value === '' || isNaN(value)) return;
    if (!rates[sourceCode]) return;
    
    const amount = parseFloat(value);
    // 逻辑：Amount / rates[source] = USD价值; USD价值 * rates[target] = 目标货币值
    const baseInUSD = amount / rates[sourceCode];

    ASSETS.forEach(asset => {
        // 排除当前正在输入的框
        if (asset.code !== sourceCode) {
            const targetInput = document.getElementById(`input-${asset.code}`);
            const result = baseInUSD * rates[asset.code];
            
            // 根据资产类型设置不同精度
            let precision = 2;
            if (asset.type === 'crypto') precision = 6;
            if (asset.type === 'metal') precision = 4;
            
            targetInput.value = Number(result.toFixed(precision));
        }
    });
}

// 刷新按钮点击
document.getElementById('refresh-icon').addEventListener('click', () => {
    // 添加旋转动画效果
    const icon = document.getElementById('refresh-icon');
    icon.style.transition = "transform 0.5s ease";
    icon.style.transform = "rotate(360deg)";
    
    fetchRates().then(() => {
        setTimeout(() => icon.style.transform = "rotate(0deg)", 500);
    });
});

// 启动
initDashboard();
fetchRates();

// 每 2 分钟自动刷新
setInterval(fetchRates, 120000);
</script>
</body>
</html>